@model SESOPtracker.Models.Entities.Equipamento
@{
    var tag = Model.tag;
    var tagRemoved = TempData["RemoveTag"] as bool? ?? false;

    var role = ViewData["Permissoes"] as SESOPtracker.Models.Entities.Permissao;
}

@if (role != null && role.permPatrimonio != null && role.permPatrimonio >= 3)
{
    <div id="addTag">
        <fieldset hidden>
            <input type="text" name="tag" />
        </fieldset>
        <button hidden>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14" /><path d="M12 5v14" /></svg>
            Adicionar tag
        </button>
        <div hidden>
            <p> @tag </p>
            <button class="btn-ghost">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>
            </button>
        </div>
    </div>
    <hr class="hl-vertical" />
    <div class="equipmentActions">
        <button class="btn-secondary saveTag" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save-icon lucide-save"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z" /><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7" /><path d="M7 3v4a1 1 0 0 0 1 1h7" /></svg>
        </button>
        <button class="btn-secondary" onclick="location.href='@Url.Action("Edit", "Equipamentos", new { id = Model.patrimonio })'">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil-icon lucide-pencil"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" /><path d="m15 5 4 4" /></svg>
        </button>
        <button class="btn-secondary" data-bs-toggle="modal" data-bs-target="#selectColumnsModal"> Exportar </button>
        <hr class="hl-vertical" />
        <button class="btn-default" data-bs-toggle="modal" data-bs-target="#deleteEquipment">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash2-icon lucide-trash-2"><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>
            Excluir
        </button>
    </div>

    @await Html.PartialAsync("_SelectColumnsModal", Model)
}


<div class="toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body"></div>
    </div>
</div>

<script type="module">
    import { toast } from "/js/toast.js"

    let tagValue = "@tag"
    let isEnterPressed = false;
    let isSaveTagClicked = false
	document.addEventListener("DOMContentLoaded", () => {
        if (tagValue == "null" || tagValue == "undefined" || tagValue == "") {
            removeTag()
        } else {
            showTag()
        }

        $("#addTag > button").on("click", function() {
            setTag()
        })

        $("#addTag input").on("blur", function() {
            if (!isEnterPressed && !isSaveTagClicked) {
                removeTag()
            }

            isEnterPressed = false
            isSaveTagClicked = false
        })

        $("#addTag input").on("keyup", function(event) {
            if (this.value.trim().length > 0) {
                $(".saveTag").removeAttr("disabled")

                if (event.which == 13) {
                    isEnterPressed = true
                    updateTagEquipment(this.value.trim())
                }
            } else {
                $(".saveTag").attr("disabled", "disabled")
            }
        })

        $(".saveTag").on("mousedown", function () {
            isSaveTagClicked = true;
        });

        $(".saveTag").on("click", function() {
            const value = $("#addTag input").val().trim()
            updateTagEquipment(value)
        })

        $("#addTag > div > button").on("click", function() {
            updateTagEquipment(null)
        })
	})

    function updateTagEquipment(value) {
        $.ajax({
            url: '@Url.Action("EditTag", "Equipamentos", new { id = Model.patrimonio })',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ tag: value }),
            success: () => {
                if (value == null) {
                    removeTag()
                    toast("success", "Tag removida com sucesso!")
                } else {
                    showTag()
                    $("#addTag > div > p").text(value)
                    toast("success", "Tag adicionada com sucesso!")
                }

                $("#addTag input").val("")
                $(".saveTag").attr("disabled", "disabled")
            },
            error: (data) => {
                toast("danger", "Ocorreu um erro, tente novamente mais tarde")
            }
        })
    }

    function removeTag() {
        $("#addTag > *").attr("hidden", "hidden")
        $("#addTag > button").removeAttr("hidden")
        $(".saveTag").attr("disabled", "disabled")
        $("#addTag input").val("")
    }
    
    function showTag() {
        $("#addTag > *").attr("hidden", "hidden")
        $("#addTag > div").removeAttr("hidden")
    }

    function setTag() {
        $("#addTag > *").attr("hidden", "hidden")
        $("#addTag > fieldset").removeAttr("hidden")
        $("#addTag > fieldset input").focus()
    }
</script>
